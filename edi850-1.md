Imports System.IO

Module EDIParser_EnvelopeAndLoops
    Sub Main()
        ' 假設有一份包含 ISA、GS、ST、以及 N9 / N1 / PO1 / CTT Loop 的 EDI 檔案
        Dim ediFilePath As String = "C:\path\to\your\file.edi"
        Dim ediContent As String = File.ReadAllText(ediFilePath)

        ' EDI 常見段分隔 "~"，元素分隔 "*"
        Dim segmentDelimiter As String = "~"
        Dim elementDelimiter As Char = "*"c

        ' 先將 EDI 切割成 segment
        Dim segments As String() = ediContent.Split(New String() {segmentDelimiter}, StringSplitOptions.RemoveEmptyEntries)

        '-----------------------------------------
        ' 1) ISA / IEA 狀態 & 收集
        '-----------------------------------------
        Dim inISA As Boolean = False
        Dim ISAsegments As New List(Of String)

        '-----------------------------------------
        ' 2) GS / GE 狀態 & 收集
        '-----------------------------------------
        Dim inGS As Boolean = False
        Dim GSsegments As New List(Of String)

        '-----------------------------------------
        ' 3) ST / SE 狀態 & 收集
        '   （ST 裡面再去處理 N9 / N1 / PO1 / CTT）
        '-----------------------------------------
        Dim inST As Boolean = False
        Dim STsegments As New List(Of String)

        ' 下列旗標 & 清單，在「進入 ST」後才會用到
        Dim inN9Loop As Boolean = False
        Dim inTopN1Loop As Boolean = False
        Dim inPO1Loop As Boolean = False
        Dim inCTTLoop As Boolean = False

        Dim N9Segments As New List(Of String)
        Dim TopN1Segments As New List(Of String)
        Dim PO1Segments As New List(Of String)
        Dim CTTSegments As New List(Of String)

        '-------------------------------------------------------
        ' 逐段掃描
        '-------------------------------------------------------
        For Each rawSeg As String In segments
            Dim seg As String = rawSeg.Trim()
            If seg = "" Then Continue For

            Dim elements = seg.Split(elementDelimiter)
            Dim segID As String = elements(0).Trim()

            Select Case segID

                '=============================
                '  ISA / IEA
                '=============================
                Case "ISA"
                    ' 如果已經在 ISA 狀態，可能表示又遇到下一個 Interchange
                    ' 先處理之前的 ISA (若需要)
                    If inISA Then
                        ProcessISA(ISAsegments)
                        ISAsegments.Clear()
                        inISA = False
                    End If
                    ' 開啟新的 ISA
                    inISA = True
                    ISAsegments.Add(seg)

                Case "IEA"
                    ' 結束 ISA
                    If inISA Then
                        ISAsegments.Add(seg)
                        ProcessISA(ISAsegments)
                        ISAsegments.Clear()
                        inISA = False
                    Else
                        ' 不在 ISA 就忽略或視為錯誤
                    End If

                '=============================
                '  GS / GE
                '=============================
                Case "GS"
                    ' 如果已在 GS 狀態，先關閉
                    If inGS Then
                        ProcessGS(GSsegments)
                        GSsegments.Clear()
                        inGS = False
                    End If
                    inGS = True
                    GSsegments.Add(seg)

                Case "GE"
                    ' 結束 GS
                    If inGS Then
                        GSsegments.Add(seg)
                        ProcessGS(GSsegments)
                        GSsegments.Clear()
                        inGS = False
                    End If

                '=============================
                '  ST / SE
                '=============================
                Case "ST"
                    ' 結束前一個 ST（若已在 ST）
                    If inST Then
                        ' 先把前一個 ST 收尾
                        FinalizeST(
                            STsegments,
                            inN9Loop, N9Segments,
                            inTopN1Loop, TopN1Segments,
                            inPO1Loop, PO1Segments,
                            inCTTLoop, CTTSegments
                        )
                        ' Reset ST 狀態
                        STsegments.Clear()
                        inST = False
                    End If
                    ' 開啟新的 ST
                    inST = True
                    STsegments.Add(seg)

                    ' ST 裡的 Loop 狀態歸零
                    inN9Loop = False
                    inTopN1Loop = False
                    inPO1Loop = False
                    inCTTLoop = False
                    N9Segments.Clear()
                    TopN1Segments.Clear()
                    PO1Segments.Clear()
                    CTTSegments.Clear()

                Case "SE"
                    ' 結束 ST
                    If inST Then
                        STsegments.Add(seg)
                        ' 收尾
                        FinalizeST(
                            STsegments,
                            inN9Loop, N9Segments,
                            inTopN1Loop, TopN1Segments,
                            inPO1Loop, PO1Segments,
                            inCTTLoop, CTTSegments
                        )
                        ' 重置
                        STsegments.Clear()
                        inST = False
                    End If

                '=============================
                ' 其餘段 -> 若在 ST 裡面，就解析 ST 內容 (N9/N1/PO1/CTT)
                '=============================
                Case Else
                    If inST Then
                        ' 把段先加到 STsegments (完整存)
                        STsegments.Add(seg)

                        ' === 進入 ST 內容的解析邏輯 ===
                        Select Case segID
                            '--------------------------------
                            '    N9 Loop (頂層)
                            '--------------------------------
                            Case "N9"
                                ' 關閉其他頂層 loop
                                If inTopN1Loop Then
                                    ProcessTopN1Loop(TopN1Segments)
                                    TopN1Segments.Clear()
                                    inTopN1Loop = False
                                End If
                                If inPO1Loop Then
                                    ProcessPO1Loop(PO1Segments)
                                    PO1Segments.Clear()
                                    inPO1Loop = False
                                End If
                                If inCTTLoop Then
                                    ProcessCTTLoop(CTTSegments)
                                    CTTSegments.Clear()
                                    inCTTLoop = False
                                End If

                                inN9Loop = True
                                N9Segments.Add(seg)

                            Case "N1"
                                If inPO1Loop Then
                                    ' => PO1 子層 N1
                                    PO1Segments.Add(seg)

                                Else
                                    ' => 頂層 N1
                                    If inN9Loop Then
                                        ProcessN9Loop(N9Segments)
                                        N9Segments.Clear()
                                        inN9Loop = False
                                    End If
                                    If inTopN1Loop Then
                                        ProcessTopN1Loop(TopN1Segments)
                                        TopN1Segments.Clear()
                                        inTopN1Loop = False
                                    End If
                                    If inCTTLoop Then
                                        ProcessCTTLoop(CTTSegments)
                                        CTTSegments.Clear()
                                        inCTTLoop = False
                                    End If

                                    inTopN1Loop = True
                                    TopN1Segments.Add(seg)
                                End If

                            Case "PO1"
                                ' 關閉其他頂層 loop
                                If inN9Loop Then
                                    ProcessN9Loop(N9Segments)
                                    N9Segments.Clear()
                                    inN9Loop = False
                                End If
                                If inTopN1Loop Then
                                    ProcessTopN1Loop(TopN1Segments)
                                    TopN1Segments.Clear()
                                    inTopN1Loop = False
                                End If
                                If inCTTLoop Then
                                    ProcessCTTLoop(CTTSegments)
                                    CTTSegments.Clear()
                                    inCTTLoop = False
                                End If

                                ' 若已在 PO1 loop，先結束
                                If inPO1Loop Then
                                    ProcessPO1Loop(PO1Segments)
                                    PO1Segments.Clear()
                                    inPO1Loop = False
                                End If

                                inPO1Loop = True
                                PO1Segments.Add(seg)

                            Case "CTT"
                                ' 關閉其他頂層 loop
                                If inN9Loop Then
                                    ProcessN9Loop(N9Segments)
                                    N9Segments.Clear()
                                    inN9Loop = False
                                End If
                                If inTopN1Loop Then
                                    ProcessTopN1Loop(TopN1Segments)
                                    TopN1Segments.Clear()
                                    inTopN1Loop = False
                                End If
                                If inPO1Loop Then
                                    ProcessPO1Loop(PO1Segments)
                                    PO1Segments.Clear()
                                    inPO1Loop = False
                                End If
                                If inCTTLoop Then
                                    ProcessCTTLoop(CTTSegments)
                                    CTTSegments.Clear()
                                    inCTTLoop = False
                                End If

                                inCTTLoop = True
                                CTTSegments.Add(seg)

                            Case Else
                                ' 若在某個 loop 裡，就繼續收集
                                If inN9Loop Then
                                    N9Segments.Add(seg)
                                ElseIf inTopN1Loop Then
                                    TopN1Segments.Add(seg)
                                ElseIf inPO1Loop Then
                                    PO1Segments.Add(seg)
                                ElseIf inCTTLoop Then
                                    CTTSegments.Add(seg)
                                Else
                                    ' 只是 ST 內其他段，不屬於任何 loop
                                End If
                        End Select
                    Else
                        ' 不在 ST 裡 => 可能是 ISA/GS層次或其他外圍段
                        If inISA Then
                            ISAsegments.Add(seg)
                        ElseIf inGS Then
                            GSsegments.Add(seg)
                        Else
                            ' 可能是一些沒在 Envelope 內的段
                        End If
                    End If

            End Select
        Next

        '----------------------------------------------------
        ' 檔案讀完後，如有未關閉的 ST 或 GS、ISA
        '----------------------------------------------------
        If inST Then
            FinalizeST(
                STsegments,
                inN9Loop, N9Segments,
                inTopN1Loop, TopN1Segments,
                inPO1Loop, PO1Segments,
                inCTTLoop, CTTSegments
            )
        End If
        If inGS Then
            ProcessGS(GSsegments)
        End If
        If inISA Then
            ProcessISA(ISAsegments)
        End If

        Console.WriteLine("=== All Parsing Complete ===")
        Console.ReadLine()
    End Sub

    '===========================================================
    '   函式區：處理 ISA、GS、ST，以及 ST 內的各個 Loop
    '===========================================================

    ''' <summary>
    ''' 處理 ISA + IEA 區段
    ''' </summary>
    Private Sub ProcessISA(isaSegs As List(Of String))
        Console.WriteLine("=== [ProcessISA] Start ===")
        For Each seg In isaSegs
            Dim elements = seg.Split("*"c)
            Select Case elements(0)
                Case "ISA"
                    Console.WriteLine($"  => ISA: Sender={elements.ElementAtOrDefault(6)}, Receiver={elements.ElementAtOrDefault(8)}, CtrlNum={elements.ElementAtOrDefault(13)}")
                Case "IEA"
                    Console.WriteLine($"  => IEA: NumberOfFunctionalGroups={elements.ElementAtOrDefault(1)}, InterchangeControlNum={elements.ElementAtOrDefault(2)}")
                Case Else
                    Console.WriteLine($"  => ISA-other: {elements(0)}")
            End Select
        Next
        Console.WriteLine("=== [ProcessISA] End ===")
    End Sub

    ''' <summary>
    ''' 處理 GS + GE 區段
    ''' </summary>
    Private Sub ProcessGS(gsSegs As List(Of String))
        Console.WriteLine("=== [ProcessGS] Start ===")
        For Each seg In gsSegs
            Dim elements = seg.Split("*"c)
            Select Case elements(0)
                Case "GS"
                    Console.WriteLine($"  => GS: FunctionalID={elements.ElementAtOrDefault(1)}, GroupCtrlNum={elements.ElementAtOrDefault(6)}")
                Case "GE"
                    Console.WriteLine($"  => GE: NumberOfST={elements.ElementAtOrDefault(1)}, GroupCtrlNum={elements.ElementAtOrDefault(2)}")
                Case Else
                    Console.WriteLine($"  => GS-other: {elements(0)}")
            End Select
        Next
        Console.WriteLine("=== [ProcessGS] End ===")
    End Sub

    ''' <summary>
    ''' Finalize ST 的收尾，並在這裡呼叫各 Loop 的處理函式
    ''' </summary>
    Private Sub FinalizeST(
        stSegs As List(Of String),
        ByRef inN9Loop As Boolean, n9Segs As List(Of String),
        ByRef inTopN1Loop As Boolean, topN1Segs As List(Of String),
        ByRef inPO1Loop As Boolean, po1Segs As List(Of String),
        ByRef inCTTLoop As Boolean, cttSegs As List(Of String)
    )
        ' 先把 ST 裡最後未結束的 Loop 都處理掉
        If inN9Loop Then
            ProcessN9Loop(n9Segs)
            n9Segs.Clear()
            inN9Loop = False
        End If
        If inTopN1Loop Then
            ProcessTopN1Loop(topN1Segs)
            topN1Segs.Clear()
            inTopN1Loop = False
        End If
        If inPO1Loop Then
            ProcessPO1Loop(po1Segs)
            po1Segs.Clear()
            inPO1Loop = False
        End If
        If inCTTLoop Then
            ProcessCTTLoop(cttSegs)
            cttSegs.Clear()
            inCTTLoop = False
        End If

        ' 最後再處理 ST 區段本身 (ST/SE)
        ProcessST(stSegs)
    End Sub

    ''' <summary>
    ''' 處理 ST / SE，印出 Transaction Set 的基本訊息
    ''' </summary>
    Private Sub ProcessST(stSegs As List(Of String))
        Console.WriteLine("=== [ProcessST] Start ===")
        For Each seg In stSegs
            Dim elements = seg.Split("*"c)
            Select Case elements(0)
                Case "ST"
                    Console.WriteLine($"  => ST: TransactionSetID={elements.ElementAtOrDefault(1)}, ControlNum={elements.ElementAtOrDefault(2)}")
                Case "SE"
                    Console.WriteLine($"  => SE: SegmentCount={elements.ElementAtOrDefault(1)}, ControlNum={elements.ElementAtOrDefault(2)}")
                Case Else
                    ' 其他段（大部分已由各 Loop 處理），這裡可視需要列印或忽略
            End Select
        Next
        Console.WriteLine("=== [ProcessST] End ===")
    End Sub

    '===========================================================
    '   下面處理 ST 之內的各個 Loop (N9, N1, PO1, CTT)
    '===========================================================

    Private Sub ProcessN9Loop(n9Segments As List(Of String))
        Console.WriteLine("=== [ProcessN9Loop] Start ===")
        For Each seg In n9Segments
            Dim elements = seg.Split("*"c)
            Select Case elements(0)
                Case "N9"
                    Console.WriteLine($"  => N9: RefID={elements.ElementAtOrDefault(1)}, FreeForm={elements.ElementAtOrDefault(2)}")
                Case "REF"
                    Console.WriteLine($"  => REF: Type={elements.ElementAtOrDefault(1)}, Value={elements.ElementAtOrDefault(2)}")
                Case "MSG"
                    Console.WriteLine($"  => MSG: {elements.ElementAtOrDefault(1)}")
                Case Else
                    Console.WriteLine($"  => N9-other: {elements(0)}")
            End Select
        Next
        Console.WriteLine("=== [ProcessN9Loop] End ===")
    End Sub

    Private Sub ProcessTopN1Loop(n1Segments As List(Of String))
        Console.WriteLine("=== [ProcessTopN1Loop] Start ===")
        For Each seg In n1Segments
            Dim elements = seg.Split("*"c)
            Select Case elements(0)
                Case "N1"
                    Console.WriteLine($"  => N1: Code={elements.ElementAtOrDefault(1)}, Name={elements.ElementAtOrDefault(2)}")
                Case "N3"
                    Console.WriteLine($"  => N3: Address={elements.ElementAtOrDefault(1)}")
                Case "N4"
                    Console.WriteLine($"  => N4: City/State/Zip={elements.ElementAtOrDefault(1)}/{elements.ElementAtOrDefault(2)}/{elements.ElementAtOrDefault(3)}")
                Case "REF"
                    Console.WriteLine($"  => REF: Type={elements.ElementAtOrDefault(1)}, Value={elements.ElementAtOrDefault(2)}")
                Case Else
                    Console.WriteLine($"  => N1-other: {elements(0)}")
            End Select
        Next
        Console.WriteLine("=== [ProcessTopN1Loop] End ===")
    End Sub

    Private Sub ProcessPO1Loop(po1Segments As List(Of String))
        Console.WriteLine("=== [ProcessPO1Loop] Start ===")

        ' 巢狀 N1 Sub-Loop
        Dim inPO1N1Loop As Boolean = False
        Dim po1N1Segments As New List(Of String)

        For Each seg In po1Segments
            Dim elements = seg.Split("*"c)
            Dim segID = elements(0)

            Select Case segID
                Case "PO1"
                    Console.WriteLine($"  => PO1: LineNo={elements.ElementAtOrDefault(1)}, Qty={elements.ElementAtOrDefault(2)}, Price={elements.ElementAtOrDefault(4)}")

                Case "N1"
                    ' 如果已經在 PO1 N1 Sub-Loop，先關閉
                    If inPO1N1Loop Then
                        ProcessPO1N1SubLoop(po1N1Segments)
                        po1N1Segments.Clear()
                        inPO1N1Loop = False
                    End If
                    inPO1N1Loop = True
                    po1N1Segments.Add(seg)

                Case "N3", "N4", "REF"
                    If inPO1N1Loop Then
                        po1N1Segments.Add(seg)
                    Else
                        Console.WriteLine($"  => (PO1-level) {segID}")
                    End If

                Case "PID"
                    Console.WriteLine($"  => PID: Description={elements.ElementAtOrDefault(4)}")
                Case "SAC"
                    Console.WriteLine($"  => SAC: Code={elements.ElementAtOrDefault(1)}, Amt={elements.ElementAtOrDefault(5)}")

                Case El